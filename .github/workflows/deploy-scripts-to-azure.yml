name: Deploy Scripts to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'src/**'
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy-scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Upload scripts to Azure Blob Storage
        run: |
          # Upload scripts directory to Azure Blob Storage
          az storage blob upload-batch \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --destination ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }} \
            --source ./scripts \
            --pattern "*.py" \
            --overwrite
          
          # Upload src directory for dependencies
          az storage blob upload-batch \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --destination ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}/src \
            --source ./src \
            --pattern "*.py" \
            --overwrite
      
      - name: Upload requirements to Azure Blob Storage
        run: |
          # Upload requirements.txt for Azure Batch to install dependencies
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --container-name ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }} \
            --file ./requirements.txt \
            --name requirements.txt \
            --overwrite
      
      - name: Deployment Summary
        run: |
          echo "‚úÖ Scripts deployed successfully to Azure Blob Storage"
          echo "üì¶ Storage Account: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}"
          echo "üìÅ Container: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}"
          echo "üìú Scripts uploaded from: ./scripts"
          echo "üìö Dependencies uploaded from: ./src"
          echo "üîß Ready for Azure Data Factory to trigger Azure Batch jobs"
